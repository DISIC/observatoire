<?xml version="1.1" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc version="1.3" reference="Demarches.Code.DemarcheAvisDetailsTab" locale="">
  <web>Demarches.Code</web>
  <name>DemarcheAvisDetailsTab</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1541670628000</creationDate>
  <parent>xwiki:Demarches.Code.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1541688020000</date>
  <contentUpdateDate>1541688020000</contentUpdateDate>
  <version>1.1</version>
  <title>DemarcheAvisDetailsTab</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity}}
{{html wiki="true" clean="false"}}

#set ($discard = $xwiki.linkx.use('//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css', {'rel': 'stylesheet'}))

#macro(displayTableRow $value $number $className $category $color)
  #set ($systemTime = $datetool.systemTime)
  #set ($xDoc = $xwiki.getDocument("XWiki.$systemTime"))
  #set ($xObj = $xDoc.newObject($className))
  #set ($discard = $xObj.set($category, $value))
  #if ($color)
    |$xDoc.display($category, $xObj)|$number|$color
  #else
    |$xDoc.display($category, $xObj)|$number
  #end
#end

#macro(addAvisDataTable $tableId $property $propertyType $propAlias $colors)
  #if (!$propAlias)
    #set ($propAlias = 'prop.value')
  #end
  #set ($className = 'Avis.Code.AvisClass')
  #set ($query = "select $propAlias, count(doc.fullName) from XWikiDocument as doc, BaseObject as obj, $propertyType, StringProperty demarche where doc.fullName = obj.name and obj.className = :className and obj.id = prop.id.id and prop.id.name = :propertyName and demarche.id.id = obj.id and demarche.id.name = 'demarche' and demarche.value = '$doc.fullName' group by $propAlias order by $propAlias desc")
  #set($list = $services.query.hql($query).bindValue('className',$className).bindValue('propertyName',$property).execute())
  ## TODO: see SSX RadioVoteDisplayer and use the color variables
  (% id="$tableId" class="hidden" %)
  #if ($colors)
    |= $property |= Données|= Couleur
  #else
    |= $property |= Données
  #end
  #foreach($item in $list)
    #set($value = $item.get(0))
    #set($number = $item.get(1))
    #if(!$number)
      #set($number = 0)
    #end
    #if ($value)
      #displayTableRow($value $number $className $property $colors.get($value))
    #end
  #end
#end

#set($chartOptions = {
    "legend": {
      "display": false
    },
    "scales": {
      "xAxes": [{
        "ticks": { "beginAtZero": true}
      }],
      "yAxes": [{
        "gridLines": {"display": false, "drawBorder": false},
        "ticks": {"fontFamily": "FontAwesome", "fontSize": 24}
       }]
    },
    "tooltips": {
      "titleFontFamily": "FontAwesome"
    }
})

#set ($colors = {1:'#e62623', 2:'#d58000', 3:'#00ac07'})
##set ($labels = {1:'frown', 2:'meh', 3:'smile'})
#set ($options = $jsontool.serialize($chartOptions).replaceAll("~","~~").replaceAll("'","~'"))

&lt;div class="tab-pane fade" role="tabpanel" id="details-tab" aria-labelledby="details-tab"&gt;
  &lt;h2&gt;Indice de satisfaction global&lt;/h2&gt;
  &lt;div class="xform"&gt;
    #set ($date = $datetool.toDate('ddMMyyyy', '15062018'))
    #set ($fDate = $datetool.format('d MMMM yyyy', $date))
    &lt;span class="xHint"&gt;$services.localization.render('avis.stats.recueil', [$fDate, $totalVotes])
  &lt;/div&gt;
  &lt;div class="row"&gt;
    &lt;div class="col-lg-6 col-md-6 col-sm-12 xform"&gt;

      {{tableToChartJS type='horizontalBar' table='score' options='$options'/}}
      #addAvisDataTable('score', 'score', 'IntegerProperty as prop', 'prop.value', $colors)

    &lt;/div&gt;
    &lt;div class="col-lg-6 col-md-6 col-sm-12"&gt;
      Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;h2&gt;Détail des avis&lt;/h2&gt;
  &lt;div class="row"&gt;
    &lt;div class="col-lg-6 col-md-6 col-sm-12"&gt;
      &lt;h3&gt;Facilité d'usage&lt;/h3&gt;

      {{tableToChartJS type='horizontalBar' table='facile' options='$options'/}}
      #addAvisDataTable('facile', 'facile', 'IntegerProperty as prop', 'prop.value', $colors)

    &lt;/div&gt;
    &lt;div class="col-lg-6 col-md-6 col-sm-12"&gt;
      &lt;h3&gt;Compréhension&lt;/h3&gt;

      {{tableToChartJS type='horizontalBar' table='comprehensible' options='$options'/}}
      #addAvisDataTable('comprehensible', 'comprehensible', 'IntegerProperty as prop', 'prop.value', $colors)

    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class="row"&gt;
    &lt;div class="col-lg-6 col-md-6 col-sm-12"&gt;
      &lt;h3&gt;Difficulté&lt;/h3&gt;
      #set ($chartOptions.scales.yAxes.get(0)["ticks"] = {"mirror": true, "padding": -10})
      #set ($options = $jsontool.serialize($chartOptions).replaceAll("~","~~").replaceAll("'","~'"))

      {{tableToChartJS type='horizontalBar' table='difficultes' options='$options'/}}
      #addAvisDataTable('difficultes', 'difficultes', 'DBStringListProperty as prop join prop.list list', 'list', $NULL)

    &lt;/div&gt;
    &lt;div class="col-lg-6 col-md-6 col-sm-12"&gt;
      &lt;h3&gt;Besoin d'aide&lt;/h3&gt;

      {{tableToChartJS type='horizontalBar' table='aide' options='$options'/}}
      #addAvisDataTable('aide', 'aide', 'DBStringListProperty as prop join prop.list list', 'list', $NULL)

    &lt;/div&gt;
  &lt;/div&gt;
  &lt;h2&gt;Modalités&lt;/h2&gt;
  &lt;div class="row"&gt;
    &lt;div class="col-lg-6 col-md-6 col-sm-12"&gt;
      &lt;h3 style="text-align:center"&gt;En ligne&lt;/h3&gt;
      #set ($discard = $chartOptions.remove('scales'))
      #set ($options = $jsontool.serialize($chartOptions).replaceAll("~","~~").replaceAll("'","~'"))
      #set ($colors = {'en-ligne-entièrement':'#82b876', 'en-ligne-partiellement':'#f9b43e', 'autrement':'#ecebec'})

      {{tableToChartJS type='pie' table='modalite' options='$options' /}}
      #addAvisDataTable('modalite', 'modalite', 'StringProperty as prop', 'prop.value', $colors)

    &lt;/div&gt;
    &lt;div class="col-lg-6 col-md-6 col-sm-12"&gt;
      &lt;h3 style="text-align:center"&gt;Autre&lt;/h3&gt;


#set ($query = $services.query.hql("select sum(case when vote.value = 'true' then 1 else 0 end), sum(case when vote.value = 'false' then 1 else 0 end) from BaseObject as avis, StringProperty as vote, StringProperty as demarche where avis.className = :avisClass and avis.id = vote.id.id and vote.id.name = :voteProperty and demarche.id.id = avis.id and demarche.id.name = :demarcheProperty and demarche.value = :demarche"))
#set ($discard = $query.bindValue("demarche", 'Demarches.1289'))
#set ($discard = $query.bindValue("avisClass", 'Avis.Code.AvisClass'))
#set ($discard = $query.bindValue("voteProperty", 'vote'))
#set ($discard = $query.bindValue("demarcheProperty", 'demarche'))
#set ($entries = $query.execute())
#set ($demandes = $entries[0][0])
#set ($autre =  $entries[0][1])
(% id="autre" class="hidden" %)
|= Vote |= Données
|Demandes de dématérialisation|$demandes
|Autre|$autre

  {{tableToChartJS type='pie' table='autre' options='$options' /}}
  
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;h2&gt;Données détaillées&lt;/h2&gt;
  &lt;form action="$xwiki.getURL('Macros.AddExcelExportToLivetableMacroResultsPage')" method='post'&gt;
    &lt;div class="buttonwrapper"&gt;
      &lt;input type="hidden" name="demarcheId" value="${escapetool.xml($doc.fullName)}" /&gt;
      &lt;input type="hidden" name='filename' value="$escapetool.xml("demarche-${doc.name}-${datetool.get('yyyy-MM-dd-HH-mm-ss')}")" /&gt;
      &lt;button class='button' type='submit'&gt;&lt;span&gt;Export CSV&lt;/button&gt;
    &lt;/div&gt;
  &lt;/form&gt;



&lt;/div&gt;
{{/html}}
{{/velocity}}</content>
</xwikidoc>
